<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AGFI • Iniciar sesión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/Styles/index.css" rel="stylesheet">
</head>
<style>
  body {
  background: url('/../Images/background.png') center/cover no-repeat;
  min-height: 100vh;
  overflow: hidden;
}
</style>
<body>
  <!-- Logo superior izquierdo -->
  <div class="position-absolute top-0 start-0 p-3">
    <img src="/Images/logo_AGFI_sinfondo.png" alt="AGFI" class="brand-mark" style="height:175px;">
  </div>

  <main class="container-fluid d-flex justify-content-end align-items-center min-vh-100 pe-lg-5">
    <div class="card shadow auth-card bg-white bg-opacity-75 p-4 p-lg-5 me-lg-5" style="max-width:420px;">
      <h1 class="h3 fw-bold mb-4 text-center">Iniciar sesión</h1>
      <p class="muted small text-center mb-4">Accede para registrar asistencia o administrar eventos.</p>

      <form id="loginForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <label for="email" class="form-label">Correo</label>
          <input type="email" class="form-control" id="email" placeholder="tu@correo.com" required>
          <div class="invalid-feedback">Escribe un correo válido.</div>
        </div>
        <div class="mb-2">
          <label for="password" class="form-label">Contraseña</label>
          <input type="password" class="form-control" id="password" placeholder="••••••••" minlength="6" required>
          <div class="invalid-feedback">La contraseña debe tener al menos 6 caracteres.</div>
        </div>
        <div class="d-flex justify-content-end mb-2">
          <a href="#" id="recuperar" class="small">¿Olvidaste tu contraseña?</a>
        </div>
        <button class="btn btn-agfi text-white w-100" type="submit">Entrar</button>
        <div id="alert" class="alert mt-3 d-none" role="status" aria-live="polite"></div>
      </form>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  const form = document.getElementById('loginForm');
  const alertBox = document.getElementById('alert');

  const API_BASE = 'http://localhost:5000'; // cámbialo luego si expones por Nginx

  function showAlert(type,msg){
    alertBox.className = 'alert mt-3 ' + (type==='ok' ? 'alert-success' : 'alert-danger');
    alertBox.textContent = msg;
    alertBox.classList.remove('d-none');
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    e.stopPropagation();
    form.classList.add('was-validated');

    const email = document.getElementById('email').value.trim();
    const pass  = document.getElementById('password').value.trim();

    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email) || pass.length < 6){
      return showAlert('err','Verifica tus datos.');
    }

    showAlert('ok','Validando…');

    try {
      const resp = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          correo: email,
          password: pass
        })
      });

      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        const msg = data.message || 'Credenciales inválidas.';
        return showAlert('err', msg);
      }

      // Guardar token y datos en localStorage
      const token = data.token;
      const user  = data.user || {};
      const rol   = user.rol || 'user';

      localStorage.setItem('agfi_token', token);
      localStorage.setItem('agfi_role', rol);
      localStorage.setItem('agfi_user_email', user.correo || email);
      localStorage.setItem('agfi_user_name', user.nombre || '');

      showAlert('ok','Acceso concedido.');

      // Redirección según rol
      setTimeout(()=>{
        if (rol === 'admin') {
          window.location.href = 'admin.html';
        } else if (rol === 'staff') {
          window.location.href = 'staff.html';
        } else {
          window.location.href = 'perfil.html';
        }
      }, 800);

    } catch (err) {
      console.error(err);
      showAlert('err','Error de conexión con el servidor.');
    }
  });

  // Recuperar contraseña demo (sigue siendo fake)
  document.getElementById('recuperar').addEventListener('click',(e)=>{
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    if(!email){
      return showAlert('err','Escribe tu correo para enviarte el enlace.');
    }
    showAlert('ok','Te enviamos un enlace de recuperación a '+email+' (demo).');
  });
})();
</script>



</body>
</html>
